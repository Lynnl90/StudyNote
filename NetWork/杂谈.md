# 杂谈

## Traceroute 的工作原理

开始时发送一个 TTL 字段为 1 的 UDP 数据报，然后将 TTL 字段每次加 1，以确定路径中的每个路由器。每个路由器在丢弃 UDP 数据报时都返回一个 ICMP 超时报文，而最终目的主机则产生一个 ICMP 端口不可达的报文。

## IP 搜索路由表的几个步骤

1. 搜索匹配的主机地址；
2. 搜索匹配的网络地址；
3. 搜索默认表项（默认表项一般在路由表中被指定为一个网络表项，其网络号为 0）；

匹配主机地址步骤始终发生在匹配网络地址步骤之前。每个主机都有一个或多个默认路由。

## 直接路由和间接路由的区别

发往直接路由的分组中不但具有指明目的端的 IP 地址，还具有其链路层地址。当分组被发往下一个间接路由时，IP 地址指明的是最终的目的地址，但是链路层地址指明的是网关（即下一站路由器）。

当为某个目的 IP 地址搜索路由表时，主机地址项必须与目的地址完全匹配，而网络地址项只需要匹配目的地址的网络号和子网号就可以了。

## 主机路由表的复杂性取决于主机所在网络的拓扑结构

1. 最简单的情况是主机根本没有没有与任何网络相连。TCP/IP 协议仍然能用于这样的主机，但是只能与自己本身通信。这种情况下的路由表只包含环回接口一项。

2. 主机连在一个局域网上，只能访问局域网上的主机。这时路由表包含两项：一项是环回接口，另一项是局域网（如以太网）。

3. 如果主机能通过单个路由器访问其他网络时，一般情况下增加一个默认表项指向该路由器。

## IP 选路小结

系统产生的或转发的每份 IP 数据报都要搜索路由表，它可以被路由守护程序或 ICMP 重定向报文修改。系统在默认的情况下不转发数据报，除非进行特殊的配置。可以用 route 命令添加静态路由，也可以利用新 ICMP 路由器发现报文来初始化和动态更新默认表项。主机在启动时可以只有一个简单的路由表，然后使用来自默认路由器的 ICMP 重定向报文进行动态更新。

## 其他

* 当路由器收到一份 IP 数据报但又不能转发时，就要发送一份 ICMP “主机不可达” 差错报文。
