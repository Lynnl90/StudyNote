# 动态选路协议

动态选路协议，用于路由器之间的通信。

## 动态选路

当相邻路由器之间进行通信，以告知对方每个路由器当前所连接的网络，这时就出现了动态选路。

路由器之间必须采用选路协议进行通信。路由器上有一个进程称为路由守护进程（routing daemon），它运行选路协议，并与其相邻的一些路由器进行通信。

动态选路并不改变内核在 IP 层的选路方式。这种选路方式称为选路机制。内核搜索路由表、查找主机路由、网络路由以及默认路由的方式并没有改变。仅仅是放置到路由表中的信息改变了——当路由随时间变化时，路由是由路由守护程序动态的增加或删除，而不是来自于引导程序文件中的 route 命令。

## RIP：选路信息协议

RIP 报文包含在 UDP 数据报中，RIP 常用的 UDP 端口号是 520。

### 正常运行流程

* 初始化。在启动一个路由守护程序时，它先判断启动了哪些接口，并在每个接口上发送一个请求报文，要求其他路由器发送完整路由表。在点对点链路中，该请求是发送给其他终点的。如果网络支持广播的话，这种请求是以广播形式发送的。目的 UDP 端口号是 520（这是其他路由器的路由守护程序端口号）。

  这种请求报文的命令字段是1，但地址系列字段设置为 0，而度量字段设置为 16。这是一种要求另一端完整路由表的特殊请求报文。

* 接收到请求。如果这个请求是刚才提到的特殊请求的话，那么路由器就会将完整的路由表发送给请求者。否则，就处理请求中的每一个表项：如果有连接到指定地址的路由，则将度量设置为我们的值，否则将度量重置为 16（16 跳，表示无法到达）

* 接收到响应。使响应生效，可能会更新路由表。可能会增加新表项，对已有的表项进行修改或者删除。

* 定期选路更新。没过**30**秒，所有或部分路由器会将其**完整**的路由表发送给相邻路由器。发送路由表可以是广播形式的（如在以太网上），或是发送给点对点链路的其他终点的。

* 触发更新。每当一条路由的度量发生改变时，就对它进行更新。不需要发送完整路由表，而只需要发送那些发生变化的表项。

每条路由都有与之相关的定时器。如果运行 RIP 的系统发现一条路由在 3 分钟内未更新，就将该路由的度量设置为 16，并标注为删除。
